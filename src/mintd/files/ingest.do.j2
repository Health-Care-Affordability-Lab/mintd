* Data ingestion for {{ project_name }}
*
* This do-file handles downloading and initial processing of raw data.
* NOTE: This script runs from the code/ directory. Data paths use ../data/

* =============================================================================
* UPDATING FOR NEW DATA (e.g., annual releases)
* =============================================================================
* Data versioning is handled by DVC. When new data becomes available:
*
* 1. Update this script to point to the new data source
* 2. Run the pipeline: dvc repro
* 3. Commit changes: git add . && git commit -m "Update to 2024 data"
* 4. Push data and code: dvc push && git push
*
* DVC tracks all versions - use `dvc diff` to see changes between versions
* and `git log` / `dvc checkout` to access previous versions.
* =============================================================================

* Import mint utilities (located in same code/ directory)
do _mintd_utils.do

* List files in raw directory
capture program drop list_raw_files
program define list_raw_files
    local raw_files : dir "$RAW_DIR" files "*"
    local file_count : word count `raw_files'

    if `file_count' > 0 {
        log_message "Found `file_count' files in RAW_DIR:"
        foreach file of local raw_files {
            log_message "  - `file'"
        }
    }
    else {
        log_message "No files found in RAW_DIR. Add raw data files to get started."
    }
end

// Main ingestion program
capture program drop main
program define main
    * Initialize logging (filename will include any parameters passed)
    ParameterAwareLogger ingest
    log_message "Starting data ingestion for {{ project_name }}..."

    * Ensure data directories exist (using global paths from _mintd_utils.do)
    capture mkdir "$DATA_DIR"
    capture mkdir "$RAW_DIR"
    capture mkdir "$INTERMEDIATE_DIR"
    capture mkdir "$FINAL_DIR"

    log_message "Directories ready:"
    log_message "  Raw data: $RAW_DIR"
    log_message "  Intermediate: $INTERMEDIATE_DIR"
    log_message "  Final data: $FINAL_DIR"

    * List existing raw files
    list_raw_files

    * ==========================================================================
    * CUSTOMIZE: Add your data ingestion logic below
    * ==========================================================================
    * Examples of common ingestion patterns:
    *
    * 1. Copy from URL:
    *    copy "https://example.com/data.csv" "$RAW_DIR/data.csv", replace
    *
    * 2. Copy from local source:
    *    copy "/path/to/source/data.csv" "$RAW_DIR/data.csv", replace
    *
    * 3. Import and save as .dta:
    *    import delimited "$RAW_DIR/data.csv", clear
    *    save "$RAW_DIR/data.dta", replace
    * ==========================================================================

    log_message "Data ingestion completed successfully."
    close_logger
end

// Run if called directly
if "`c(mode)'" != "batch" {
    main
}
