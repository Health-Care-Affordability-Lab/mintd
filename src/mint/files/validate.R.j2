#' Data validation for {{ project_name }}
#'
#' This script runs quality checks and validation on processed data.

# Import mint utilities
source("_mint_utils.R")

# Set up directories
set_directories <- function() {
  dirs <- list(
    raw = file.path("data", "raw"),
    intermediate = file.path("data", "intermediate"),
    final = file.path("data", "final")
  )

  lapply(dirs, function(d) {
    if (!dir.exists(d)) dir.create(d, recursive = TRUE)
  })

  return(dirs)
}

validate_dataset <- function(df, dataset_name, logger) {
  #' Run validation checks on a dataset
  issues <- list()

  # Check for missing values
  missing_cols <- names(df)[sapply(df, function(x) any(is.na(x)))]
  if (length(missing_cols) > 0) {
    issues <- c(issues, paste("Missing values in columns:", paste(missing_cols, collapse = ", ")))
  }

  # Check for duplicate rows
  duplicates <- sum(duplicated(df))
  if (duplicates > 0) {
    issues <- c(issues, paste("Found", duplicates, "duplicate rows"))
  }

  # Check for numeric columns
  numeric_cols <- names(df)[sapply(df, is.numeric)]
  if (length(numeric_cols) == 0) {
    issues <- c(issues, "No numeric columns found")
  }

  # Basic statistics
  logger$log("Validation for ", dataset_name, ":")
  logger$log("  Rows: ", nrow(df))
  logger$log("  Columns: ", ncol(df))
  logger$log("  Numeric columns: ", length(numeric_cols))

  if (length(issues) > 0) {
    logger$log("  Issues found:")
    for (issue in issues) {
      logger$log("    - ", issue)
    }
  } else {
    logger$log("  ✓ No issues found")
  }

  return(length(issues) == 0)
}

main <- function() {
  # Initialize logging (filename will include any parameters passed)
  logger <- ParameterAwareLogger("validate")
  logger$log("Starting data validation for {{ project_name }}...")

  dirs <- set_directories()

  logger$log("Directories ready:")
  logger$log("  Raw data: ", dirs$raw)
  logger$log("  Intermediate: ", dirs$intermediate)
  logger$log("  Final data: ", dirs$final)

  # TODO: Implement comprehensive validation logic
  # - Load cleaned data from data/intermediate/
  # - Run quality checks (missing values, duplicates, data types)
  # - Business rule validation
  # - Statistical checks
  # - Save validation reports

  # Example validation
  # library(readr)
  #
  # intermediate_files <- list.files(dirs$intermediate, pattern = "*.csv", full.names = TRUE)
  # all_valid <- TRUE
  #
  # for (intermediate_file in intermediate_files) {
  #   df <- read_csv(intermediate_file)
  #   is_valid <- validate_dataset(df, basename(intermediate_file), logger)
  #   all_valid <- all_valid && is_valid
  # }
  #
  # if (all_valid) {
  #   logger$log("✓ All datasets passed validation")
  # } else {
  #   logger$log("✗ Some datasets failed validation - review issues above")
  # }

  logger$log("Data validation completed successfully.")
  logger$close()
}

if (!interactive()) {
  main()
}